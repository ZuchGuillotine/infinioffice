
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Organization {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  plan          String    @default("starter")
  smsBranding   String?
  createdAt     DateTime  @default(now()) @db.Timestamptz
  updatedAt     DateTime  @updatedAt @db.Timestamptz
  
  // Relations
  users         User[]
  calls         Call[]
  appointments  Appointment[]
  businessConfig BusinessConfig?
  integrations  Integration[]
}

model User {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  email          String   @unique
  role           String   @default("operator") // admin, operator, viewer
  googleId       String?  @unique
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model BusinessConfig {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String   @unique @db.Uuid
  businessHours     Json?    // {monday: {start: "09:00", end: "17:00"}, ...}
  holidays          Json?    // Array of holiday dates
  services          Json?    // Array of service types with durations
  providers         Json?    // Array of provider names
  escalationNumber  String?
  smsCopy           String?
  greeting          String?
  timezone          String   @default("America/New_York")
  createdAt         DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz
  
  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Integration {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  type           String   // google_calendar, outlook_calendar, hubspot, salesforce, stripe
  oauthTokens    Json?    // Encrypted OAuth tokens
  scopes         Json?    // Array of granted scopes
  status         String   @default("pending") // pending, active, error
  externalId     String?  // External system ID
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Call {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String?   @db.Uuid
  twilioCallSid   String?   @db.VarChar(100)
  callerPhone     String?   @db.VarChar(20)
  status          String?   @db.VarChar(50)
  currentState    String?   @db.VarChar(100)
  context         Json?
  finalContext    Json?
  durationSeconds Int?
  totalTurns      Int?
  transcript      String?
  recordingUrl    String?
  metadata        Json?
  error           String?
  startedAt       DateTime? @db.Timestamptz
  endedAt         DateTime? @db.Timestamptz
  lastTransition  DateTime? @db.Timestamptz
  createdAt       DateTime  @default(now()) @db.Timestamptz
  
  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  turns           Turn[]
}

model Turn {
  id            BigInt   @id @default(autoincrement())
  callId        String   @db.Uuid
  turnIndex     Int
  asrMs         Int?
  llmMs         Int?
  ttsMs         Int?
  transcriptIn  String?
  transcriptOut String?
  createdAt     DateTime @default(now()) @db.Timestamptz
  
  // Relations
  call          Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
}

model Appointment {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String   @db.Uuid
  externalId        String?
  calendarProvider  String?  @db.VarChar
  startAt           DateTime @db.Timestamptz
  endAt             DateTime @db.Timestamptz
  service           String?
  provider          String?
  contactPhone      String?  @db.VarChar(20)
  notes             String?
  status            String?  @db.VarChar
  createdAt         DateTime @default(now()) @db.Timestamptz
  
  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}
